name: Test Against Release Service Catalog

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      catalog_repo:
        description: 'Catalog repository (owner/repo)'
        required: false
        default: 'konflux-ci/release-service-catalog'
        type: string
      catalog_branch:
        description: 'Catalog branch to test against'
        required: false
        default: 'development'
        type: string
      utils_image:
        description: 'Utils image to test (leave empty to use PR image)'
        required: false
        default: ''
        type: string

env:
  CATALOG_REPO: ${{ inputs.catalog_repo || 'konflux-ci/release-service-catalog' }}
  CATALOG_BRANCH: ${{ inputs.catalog_branch || 'development' }}

jobs:
  test-with-catalog:
    name: Test Utils PR Image Against Catalog
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
    
    steps:
      - name: Checkout release-service-utils
        uses: actions/checkout@v4
        with:
          path: release-service-utils
      
      - name: Wait for Konflux image build
        id: get-image
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd release-service-utils
          
          # Check if user provided a manual image
          MANUAL_IMAGE="${{ inputs.utils_image }}"
          
          if [ -n "$MANUAL_IMAGE" ]; then
            echo "Using manually specified image: ${MANUAL_IMAGE}"
            echo "pr_image=${MANUAL_IMAGE}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Waiting for Konflux to build PR image..."
          PR_NUMBER="${{ github.event.pull_request.number }}"
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Wait for the Konflux PipelineRun to complete (max 30 minutes)
          MAX_WAIT=1800
          ELAPSED=0
          SLEEP_INTERVAL=30
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check if the konflux check has completed
            STATUS=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/commits/${COMMIT_SHA}/check-runs" \
              --jq '.check_runs[] | select(.name | contains("pull-request")) | .status' \
              | head -1)
            
            if [ "$STATUS" = "completed" ]; then
              CONCLUSION=$(gh api \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/${{ github.repository }}/commits/${COMMIT_SHA}/check-runs" \
                --jq '.check_runs[] | select(.name | contains("pull-request")) | .conclusion' \
                | head -1)
              
              if [ "$CONCLUSION" = "success" ]; then
                echo "‚úì Konflux build completed successfully"
                break
              else
                echo "‚úó Konflux build failed with conclusion: $CONCLUSION"
                exit 1
              fi
            fi
            
            echo "Build status: $STATUS (waiting ${ELAPSED}s/${MAX_WAIT}s)"
            sleep $SLEEP_INTERVAL
            ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "‚úó Timeout waiting for Konflux build"
            exit 1
          fi
          
          # Construct the PR image URL
          # Konflux builds PR images with the format: quay.io/konflux-ci/release-service-utils:pr-<number>
          PR_IMAGE="quay.io/konflux-ci/release-service-utils:pr-${PR_NUMBER}"
          
          echo "pr_image=${PR_IMAGE}" >> $GITHUB_OUTPUT
          echo "Using PR image: ${PR_IMAGE}"
      
      - name: Checkout release-service-catalog
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CATALOG_REPO }}
          ref: ${{ env.CATALOG_BRANCH }}
          path: release-service-catalog
          token: ${{ secrets.CATALOG_PR_TOKEN || github.token }}
      
      - name: Configure git
        run: |
          cd release-service-catalog
          git config user.name "release-utils-bot"
          git config user.email "release-utils-bot@users.noreply.github.com"
      
      - name: Create catalog test branch
        id: create-branch
        run: |
          cd release-service-catalog
          
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BRANCH_NAME="test-utils-pr-${PR_NUMBER}"
          
          # Delete branch if it exists (for PR updates)
          git branch -D "$BRANCH_NAME" 2>/dev/null || true
          git push origin --delete "$BRANCH_NAME" 2>/dev/null || true
          
          # Create new branch
          git checkout -b "$BRANCH_NAME"
          
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
      
      - name: Replace utils images
        run: |
          cd release-service-catalog
          chmod +x scripts/replace-utils-image.sh
          ./scripts/replace-utils-image.sh "${{ steps.get-image.outputs.pr_image }}"
      
      - name: Commit and push changes
        id: push-changes
        run: |
          cd release-service-catalog
          
          git add tasks/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git commit -m "test: use release-service-utils PR #${{ github.event.pull_request.number }} image

          Testing with image: ${{ steps.get-image.outputs.pr_image }}
          
          This is an automated test PR created by the release-service-utils CI.
          Original PR: ${{ github.event.pull_request.html_url }}
          
          DO NOT MERGE - This PR will be automatically closed after testing."
          
          git push -u origin "${{ steps.create-branch.outputs.branch_name }}"
          echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: Create catalog PR
        id: create-pr
        if: steps.push-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.CATALOG_PR_TOKEN || github.token }}
        run: |
          cd release-service-catalog
          
          PR_BODY="## ü§ñ Automated Test PR
          
          This PR tests [release-service-utils PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}) against the catalog.
          
          ### Changes
          - Replaced all \`release-service-utils\` image references with: \`${{ steps.get-image.outputs.pr_image }}\`
          
          ### What happens next?
          1. ‚úÖ If CI passes ‚Üí Original PR can be safely merged
          2. ‚ùå If CI fails ‚Üí Original PR needs fixes before merging
          
          **This PR will be automatically closed after testing completes. DO NOT MERGE.**
          
          ---
          üîó **Original PR:** ${{ github.event.pull_request.html_url }}
          üè∑Ô∏è **Image:** \`${{ steps.get-image.outputs.pr_image }}\`"
          
          PR_URL=$(gh pr create \
            --title "test: utils PR #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}" \
            --body "$PR_BODY" \
            --base "${{ env.CATALOG_BRANCH }}" \
            --head "${{ steps.create-branch.outputs.branch_name }}" \
            --label "automated-test" \
            --label "do-not-merge")
          
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          echo "Created catalog PR: ${PR_URL}"
      
      - name: Comment on utils PR
        if: steps.push-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd release-service-utils
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ü§ñ **Automated Catalog Testing**
          
          A test PR has been created in release-service-catalog to validate this change:
          üëâ ${{ steps.create-pr.outputs.pr_url }}
          
          The catalog CI will run e2e tests with your PR image (\`${{ steps.get-image.outputs.pr_image }}\`).
          
          This PR's status will be updated based on those results."
      
      - name: Monitor catalog PR CI
        if: steps.push-changes.outputs.has_changes == 'true'
        id: monitor-ci
        env:
          GH_TOKEN: ${{ secrets.CATALOG_PR_TOKEN || github.token }}
        run: |
          cd release-service-catalog
          
          # Extract PR number from URL
          PR_NUMBER=$(echo "${{ steps.create-pr.outputs.pr_url }}" | grep -oP 'pull/\K[0-9]+')
          
          echo "Monitoring catalog PR #${PR_NUMBER} CI status..."
          
          # Wait for CI to complete (max 2 hours)
          MAX_WAIT=7200
          ELAPSED=0
          SLEEP_INTERVAL=60
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Get the commit SHA for the catalog PR
            COMMIT_SHA=$(gh pr view $PR_NUMBER --json headRefOid --jq '.headRefOid')
            
            # Get all check runs for this commit
            CHECKS=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ env.CATALOG_REPO }}/commits/${COMMIT_SHA}/check-runs")
            
            TOTAL_CHECKS=$(echo "$CHECKS" | jq '.total_count')
            
            if [ "$TOTAL_CHECKS" -eq 0 ]; then
              echo "No checks started yet (waiting ${ELAPSED}s/${MAX_WAIT}s)"
              sleep $SLEEP_INTERVAL
              ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
              continue
            fi
            
            # Check if all checks are completed
            PENDING=$(echo "$CHECKS" | jq '[.check_runs[] | select(.status != "completed")] | length')
            
            if [ "$PENDING" -gt 0 ]; then
              COMPLETED=$(echo "$CHECKS" | jq '[.check_runs[] | select(.status == "completed")] | length')
              echo "CI Progress: ${COMPLETED}/${TOTAL_CHECKS} checks completed (waiting ${ELAPSED}s/${MAX_WAIT}s)"
              sleep $SLEEP_INTERVAL
              ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
              continue
            fi
            
            # All checks completed - check conclusions
            FAILED=$(echo "$CHECKS" | jq '[.check_runs[] | select(.conclusion != "success" and .conclusion != "skipped" and .conclusion != "neutral")] | length')
            
            if [ "$FAILED" -gt 0 ]; then
              echo "‚úó Catalog CI failed ($FAILED check(s) failed)"
              echo "ci_result=failure" >> $GITHUB_OUTPUT
              
              # List failed checks
              echo "Failed checks:"
              echo "$CHECKS" | jq -r '.check_runs[] | select(.conclusion != "success" and .conclusion != "skipped" and .conclusion != "neutral") | "  - \(.name): \(.conclusion)"'
              
              exit 1
            else
              echo "‚úì All catalog CI checks passed!"
              echo "ci_result=success" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          
          echo "‚úó Timeout waiting for catalog CI"
          echo "ci_result=timeout" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Update utils PR status
        if: always() && steps.push-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd release-service-utils
          
          CI_RESULT="${{ steps.monitor-ci.outputs.ci_result }}"
          
          if [ "$CI_RESULT" = "success" ]; then
            EMOJI="‚úÖ"
            STATUS="**PASSED**"
            MESSAGE="All catalog e2e tests passed! This PR is safe to merge."
          elif [ "$CI_RESULT" = "failure" ]; then
            EMOJI="‚ùå"
            STATUS="**FAILED**"
            MESSAGE="Catalog e2e tests failed. Please review the failures before merging."
          else
            EMOJI="‚è±Ô∏è"
            STATUS="**TIMEOUT**"
            MESSAGE="Catalog CI timed out. Check the test PR manually."
          fi
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "${EMOJI} **Catalog Testing ${STATUS}**
          
          ${MESSAGE}
          
          üìä View test results: ${{ steps.create-pr.outputs.pr_url }}"
      
      - name: Close catalog test PR
        if: always() && steps.push-changes.outputs.has_changes == 'true' && steps.monitor-ci.outputs.ci_result != ''
        env:
          GH_TOKEN: ${{ secrets.CATALOG_PR_TOKEN || github.token }}
        run: |
          cd release-service-catalog
          
          PR_NUMBER=$(echo "${{ steps.create-pr.outputs.pr_url }}" | grep -oP 'pull/\K[0-9]+')
          
          gh pr close $PR_NUMBER --comment "ü§ñ Automated test completed. Closing this test PR.
          
          Result: ${{ steps.monitor-ci.outputs.ci_result }}
          
          See the original PR for details: ${{ github.event.pull_request.html_url }}"
          
          # Delete the branch
          git push origin --delete "${{ steps.create-branch.outputs.branch_name }}" || true

